<?xml version="1.0" encoding="UTF-8"?><workflow name="PET-Sorteo">  <interface>    <source name="text_protocol" type="string" />    <source name="fantome_v" type="string" />    <source name="SimulationName" type="string" />    <constant name="basedir" type="string" value="/grid/biomed/creatis/vip/results" cardinality="scalar" />    <sink name="binary_protocol" type="string" />    <sink name="modified_binary_protocol_and_emission_file" type="string" />    <sink name="ccs_file_singles" type="string" />    <sink name="proto_tgz" type="string" />    <sink name="desintegrations_and_prompts_and_delayed" type="string" />    <sink name="ccs_file" type="string" />    <sink name="sinogram" type="string" />  </interface>  <processors>    <processor name="generateJobs" >      <in name="nlines" type="string" depth="0" />      <out name="array" type="string" depth="1" />      <beanshell>int n = Integer.parseInt(nlines);array = new ArrayList();for (int i =1; i&lt;=n;i++)  array.add(""+i);      </beanshell>    </processor>    <processor name="sorteo_single_end" >      <in name="input1" type="string" depth="0" />      <in name="input0" type="string" depth="0" />      <out name="result1" type="string" depth="0" />      <out name="result0" type="string" depth="0" />      <iterationstrategy>        <cross>          <port name="input1" />          <port name="input0" />        </cross>      </iterationstrategy>      <gasw descriptor="lfn://lfc-biomed.in2p3.fr:5010/grid/biomed/creatis/vip/tools/activitites/simulator_components/sorteo/sorteo_single_end/sorteo_single_end.xml" />    </processor>    <processor name="sorteo_emission_end" >      <in name="input2" type="string" depth="0" />      <in name="input1" type="string" depth="0" />      <in name="input0" type="string" depth="0" />      <out name="result0" type="string" depth="0" />      <iterationstrategy>        <cross>          <port name="input2" />          <port name="input0" />          <port name="input1" />        </cross>      </iterationstrategy>      <gasw descriptor="lfn://lfc-biomed.in2p3.fr:5010/grid/biomed/creatis/vip/tools/activitites/simulator_components/sorteo/sorteo_emission_end/sorteo_emission_end.xml" />    </processor>    <processor name="CompileProtocol" >      <in name="input2" type="string" depth="0" />      <in name="input1" type="string" depth="0" />      <in name="input0" type="string" depth="0" />      <out name="result0" type="string" depth="0" />      <iterationstrategy>        <cross>          <port name="input1" />          <port name="input0" />          <port name="input2" />        </cross>      </iterationstrategy>      <gasw descriptor="lfn://lfc-biomed.in2p3.fr:5010/grid/biomed/creatis/vip/tools/activitites/simulator_components/sorteo/CompileProtocol/CompileProtocol.xml" />    </processor>    <processor name="sorteo_emission" >      <in name="input3" type="string" depth="0" />      <in name="input2" type="string" depth="0" />      <in name="input1" type="string" depth="0" />      <in name="input0" type="string" depth="0" />      <out name="result0" type="string" depth="0" />      <iterationstrategy>        <cross>          <port name="input1" />          <port name="input3" />          <port name="input2" />          <port name="input0" />        </cross>      </iterationstrategy>      <gasw descriptor="lfn://lfc-biomed.in2p3.fr:5010/grid/biomed/creatis/vip/tools/activitites/simulator_components/sorteo/sorteo_emission/sorteo_emission.xml" />    </processor>    <processor name="sorteo_singles" >      <in name="input2" type="string" depth="0" />      <in name="input1" type="string" depth="0" />      <in name="input0" type="string" depth="0" />      <out name="result0" type="string" depth="0" />      <iterationstrategy>        <cross>          <port name="input2" />          <port name="input1" />          <port name="input0" />        </cross>      </iterationstrategy>      <gasw descriptor="lfn://lfc-biomed.in2p3.fr:5010/grid/biomed/creatis/vip/tools/activitites/simulator_components/sorteo/sorteo_singles/sorteo_single.xml" />    </processor>    <processor name="parse_text_protocol" >      <in name="LFN_text_protocol" type="string" depth="0" />      <out name="ccs_file_name" type="string" depth="0" />      <out name="process_number" type="string" depth="0" />      <beanshell>//start of Beanshell code        String lfn = LFN_text_protocol.substring(LFN_text_protocol.indexOf("/grid"));        Process p1 = null;        String srmTimeout = "300", connectTimeout="30", sendReceiveTimeout="900", bdiiTimeout="30";        String localName="proto.txt";        Runtime rt = Runtime.getRuntime();        String[] cmd1 = new String[12];        cmd1[0] = "lcg-cp";        cmd1[1] = "--connect-timeout";        cmd1[2] = connectTimeout;        cmd1[3] = "--sendreceive-timeout";        cmd1[4] = sendReceiveTimeout;        cmd1[5]="--bdii-timeout";        cmd1[6] = bdiiTimeout;        cmd1[7] = "--srm-timeout";        cmd1[8] = srmTimeout;        cmd1[9] = "-v";        cmd1[10] = "lfn:" + lfn;        cmd1[11] = "file:"+localName;        p1 = rt.exec(cmd1);        p1.waitFor();        BufferedReader in = new BufferedReader(new InputStreamReader(p1.getInputStream()));        String line = "";        while ((line = in.readLine()) != null) {            System.out.println(line);        }        BufferedReader err = new BufferedReader(new InputStreamReader(p1.getErrorStream()));        String lineerr = "";        while ((lineerr = err.readLine()) != null) {            System.out.println(lineerr);        }        p1.getErrorStream().close();        p1.getInputStream().close();        p1.getOutputStream().close();        if (p1.exitValue() != 0) {            throw new Exception("Problem downloading file " + lfn);        }	String textKey="lmf emission";        Scanner awk = new Scanner(new File(localName)).useDelimiter(textKey);        if (awk.hasNext()) {            ccs_file_name = awk.next();            if (awk.hasNext())                ccs_file_name = (awk.next().trim().split("\n"))[0];            else throw new Exception("Cannot find string \""+textKey+"\" in text protocol");        }        else throw new Exception("Cannot find string \""+textKey+"\" in text protocol");        awk.close();textKey="process_number"; awk = new Scanner(new File(localName)).useDelimiter(textKey);        if (awk.hasNext()) {            process_number = awk.next();            if (awk.hasNext())                process_number = (awk.next().trim().split("\n"))[0];            else throw new Exception("Cannot find string \""+textKey+"\" in text protocol");        }        else throw new Exception("Cannot find string \""+textKey+"\" in text protocol");        awk.close();      </beanshell>    </processor>    <processor name="appendDate" >      <in name="dir" type="string" depth="0" />      <out name="result" type="string" depth="0" />      <beanshell>import java.text.DateFormat;import java.text.SimpleDateFormat;import java.util.Date;DateFormat dateFormat = new SimpleDateFormat("dd-MM-yyyy_HH:mm:ss");String result = dir+"/"+(dateFormat.format(System.currentTimeMillis()));      </beanshell>    </processor>    <processor name="LMF2RAWSINO" >      <in name="input2" type="string" depth="0" />      <in name="input1" type="string" depth="0" />      <in name="input0" type="string" depth="0" />      <out name="result0" type="string" depth="0" />      <iterationstrategy>        <cross>          <port name="input0" />          <port name="input1" />          <port name="input2" />        </cross>      </iterationstrategy>      <gasw descriptor="lfn://lfc-biomed.in2p3.fr:5010/grid/biomed/creatis/vip/tools/activitites/simulator_components/sorteo/LMF2RAWSINO/LMF2RAWSINO.xml" />    </processor>    <processor name="concatenate" >      <in name="relative_dir" type="string" depth="0" />      <in name="basedir" type="string" depth="0" />      <out name="out" type="string" depth="0" />      <iterationstrategy>        <cross>          <port name="basedir" />          <port name="relative_dir" />        </cross>      </iterationstrategy>      <beanshell>out=basedir+"/"+relative_dir;      </beanshell>    </processor>  </processors>  <links>      <link from="text_protocol" to="CompileProtocol:input0" />      <link from="fantome_v" to="CompileProtocol:input1" />      <link from="CompileProtocol:result0" to="sorteo_singles:input0" />      <link from="sorteo_single_end:result0" to="sorteo_emission:input3" />      <link from="sorteo_single_end:result0" to="sorteo_emission_end:input1" />      <link from="sorteo_single_end:result1" to="sorteo_emission:input2" />      <link from="CompileProtocol:result0" to="binary_protocol" />      <link from="sorteo_emission:result0" to="desintegrations_and_prompts_and_delayed" />      <link from="sorteo_emission_end:result0" to="ccs_file" />      <link from="sorteo_single_end:result0" to="ccs_file_singles" />      <link from="sorteo_single_end:result1" to="proto_tgz" />      <link from="sorteo_singles:result0" to="modified_binary_protocol_and_emission_file" />      <link from="generateJobs:array" to="sorteo_singles:input1" />      <link from="generateJobs:array" to="sorteo_emission:input0" />      <link from="text_protocol" to="parse_text_protocol:LFN_text_protocol" />      <link from="parse_text_protocol:ccs_file_name" to="sorteo_single_end:input1" />      <link from="parse_text_protocol:process_number" to="generateJobs:nlines" />      <link from="SimulationName" to="appendDate:dir" />      <link from="sorteo_single_end:result1" to="sorteo_emission_end:input0" />      <link from="sorteo_emission_end:result0" to="LMF2RAWSINO:input1" />      <link from="CompileProtocol:result0" to="LMF2RAWSINO:input0" />      <link from="LMF2RAWSINO:result0" to="sinogram" />      <link from="basedir" to="concatenate:basedir" />      <link from="appendDate:result" to="concatenate:relative_dir" />      <link from="concatenate:out" to="CompileProtocol:input2" />      <link from="concatenate:out" to="sorteo_singles:input2" />      <link from="concatenate:out" to="sorteo_emission:input1" />      <link from="concatenate:out" to="sorteo_single_end:input0" />      <link from="concatenate:out" to="sorteo_emission_end:input2" />      <link from="concatenate:out" to="LMF2RAWSINO:input2" />  </links>  <coordinations>      <link from="sorteo_singles" to="sorteo_single_end" />      <link from="sorteo_emission" to="sorteo_emission_end" />  </coordinations></workflow>